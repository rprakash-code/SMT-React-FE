using System.Net.Http;
using System.Net.Http.Headers;
using System.Text;
using System.Text.Json;
using System.Text.Json.Serialization;

public class IAMService
{
    private readonly HttpClient _httpClient;

    public IAMService(HttpClient httpClient)
    {
        _httpClient = httpClient;
    }

    // Get Role Members
    public async Task<List<RoleMember>> GetIDNRoleMembersAsync(string offset, string limit, string roleName, string roleId, string accessToken)
    {
        var headers = new Dictionary<string, string>
        {
            { "Authorization", $"Bearer {accessToken}" },
            { "Accept", "application/json" },
            { "Content-Type", "application/json" }
        };

        var requestBody = new
        {
            indices = new[] { "identities" },
            query = new { query = $"@access(id:\"{roleId}\")" },
            sort = new[] { "name" },
            queryResultFilter = new { includes = new[] { "*" } }
        };

        var requestUri = $"https://your-api-url.com/search?offset={offset}&limit={limit}";
        var response = await PostApiAsync(requestUri, requestBody, headers);

        if (response != null)
        {
            return JsonSerializer.Deserialize<List<RoleMember>>(response);
        }

        return new List<RoleMember>();
    }

    // Get Roles by API ID
    public async Task<List<Role>> GetRolesByAPIDAsync(string sourceName, string accessProfileId, string accessToken)
    {
        var headers = new Dictionary<string, string>
        {
            { "Authorization", $"Bearer {accessToken}" },
            { "Accept", "application/json" },
            { "Content-Type", "application/json" }
        };

        var requestBody = new
        {
            indices = new[] { "roles" },
            query = new { query = $"accessProfiles.id:\"{accessProfileId}\"" },
            sort = new[] { "name" },
            queryResultFilter = new { includes = new[] { "*" } }
        };

        var requestUri = $"https://your-api-url.com/search";
        var response = await PostApiAsync(requestUri, requestBody, headers);

        if (response != null)
        {
            return JsonSerializer.Deserialize<List<Role>>(response);
        }

        return new List<Role>();
    }

    // Get Access Profiles
    public async Task<List<AccessProfile>> GetAccessProfilesAsync(string sourceName, string accessToken)
    {
        var headers = new Dictionary<string, string>
        {
            { "Authorization", $"Bearer {accessToken}" },
            { "Accept", "application/json" },
            { "Content-Type", "application/json" }
        };

        var requestBody = new
        {
            indices = new[] { "accessprofiles" },
            query = new { query = $"source.name:\"{sourceName}\"" },
            sort = new[] { "name" },
            queryResultFilter = new { includes = new[] { "*" } }
        };

        var response = await PostApiAsync("https://your-api-url.com/search", requestBody, headers);

        if (response != null)
        {
            return JsonSerializer.Deserialize<List<AccessProfile>>(response);
        }

        return new List<AccessProfile>();
    }

    private async Task<string> PostApiAsync(string url, object body, Dictionary<string, string> headers)
    {
        var request = new HttpRequestMessage(HttpMethod.Post, url)
        {
            Content = new StringContent(JsonSerializer.Serialize(body), Encoding.UTF8, "application/json")
        };

        foreach (var header in headers)
        {
            request.Headers.Add(header.Key, header.Value);
        }

        var response = await _httpClient.SendAsync(request);
        response.EnsureSuccessStatusCode();

        return await response.Content.ReadAsStringAsync();
    }
}





Controller

using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("api/[controller]")]
public class IAMController : ControllerBase
{
    private readonly IAMService _iamService;

    public IAMController(IAMService iamService)
    {
        _iamService = iamService;
    }

    [HttpGet("GetRoleMembers")]
    public async Task<IActionResult> GetRoleMembers(
        [FromQuery] string offset,
        [FromQuery] string limit,
        [FromQuery] string roleName,
        [FromQuery] string roleId,
        [FromHeader] string accessToken)
    {
        try
        {
            var result = await _iamService.GetIDNRoleMembersAsync(offset, limit, roleName, roleId, accessToken);
            return Ok(result);
        }
        catch (Exception ex)
        {
            return StatusCode(500, new { message = "An error occurred.", error = ex.Message });
        }
    }

    [HttpGet("GetRolesByAPID")]
    public async Task<IActionResult> GetRolesByAPID(
        [FromQuery] string sourceName,
        [FromQuery] string accessProfileId,
        [FromHeader] string accessToken)
    {
        try
        {
            var result = await _iamService.GetRolesByAPIDAsync(sourceName, accessProfileId, accessToken);
            return Ok(result);
        }
        catch (Exception ex)
        {
            return StatusCode(500, new { message = "An error occurred.", error = ex.Message });
        }
    }

    [HttpGet("GetAccessProfiles")]
    public async Task<IActionResult> GetAccessProfiles(
        [FromQuery] string sourceName,
        [FromHeader] string accessToken)
    {
        try
        {
            var result = await _iamService.GetAccessProfilesAsync(sourceName, accessToken);
            return Ok(result);
        }
        catch (Exception ex)
        {
            return StatusCode(500, new { message = "An error occurred.", error = ex.Message });
        }
    }
}




Model

public class RoleMember
{
    [JsonPropertyName("attributes_uid")]
    public string AttributesUid { get; set; }
}

public class Role
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
}

public class AccessProfile
{
    public string Id { get; set; }
    public string Name { get; set; }
    public string Description { get; set; }
}


builder.Services.AddHttpClient<IAMService>();
